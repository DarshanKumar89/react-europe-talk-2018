// @flow
import React, { PureComponent } from 'react';

import { defaultShapes } from './confetti-shapes.js';

class Particles extends PureComponent {
  static propTypes = {
    width: PropTypes.number.isRequired,
    height: PropTypes.number.isRequired,
    shapes: PropTypes.array,
    numParticles: PropTypes.number,
    emitDuration: PropTypes.number,
    gravity: PropTypes.number,
    spin: PropTypes.number,
    twist: PropTypes.number,
    minSpeed: PropTypes.number,
    maxSpeed: PropTypes.number,
    minScale: PropTypes.number,
    maxScale: PropTypes.number,
    children: PropTypes.func.isRequired,
  };

  static defaultProps = {
    shapes: defaultShapes,
    numParticles: 100,
    emitDuration: 1000,
    gravity: 1600,
    spin: 20,
    twist: 0,
    minSpeed: 225,
    maxSpeed: 675,
    minScale: 0.4,
    maxScale: 1.0,
  };

  state = {
    particles: [],
    status: 'idle',
  };

  componentDidUpdate(prevProps, prevState) {
    if (
      prevState.status === 'idle' &&
      this.state.status === 'running'
    ) {
      this.tick();
    }
  }

  componentWillUnmount() {
    window.cancelAnimationFrame(this.rafId);
  }

  generateParticles = () => {
    const newParticles = range(
      this.props.numParticles
    ).map(i => {
      // ✂️ Snip ✂️
      // Initialize all of the variables
      // like scale, speed, and amount of
      // spin/twist.

      // const angle = /* snip */
      // const trajectoryVariance = /* snip */
      // const trajectory = /* snip */
      // const vx = /* snip */
      // const vy = /* snip */

      return {
        birth,
        initialPosition,
        currentPosition: initialPosition,
        spinForce,
        twistForce,
        currentSpin,
        currentTwist,
        angle,
        scale,
        vx,
        vy,
        front,
        back,
        width: front.naturalWidth,
        height: front.naturalHeight,
      };
    });

    this.setState({
      status: 'running',
      particles: [
        ...this.state.particles,
        newParticles,
      ],
    });
  };

  tick = () => {
    if (this.state.particles.length === 0) {
      this.setState({ status: 'idle' });
      return;
    }

    const particles = this.getNextParticles();

    this.rafId = window.requestAnimationFrame(
      () => {
        this.setState(
          { particles },
          this.tick
        );
      }
    );
  };

  getNextParticles = () => {
    const { height, width } = this.props;

    return this.state.particles
      .map(particle => {
        // ✂️ Snip ✂️
        // Calculate the next values for all
        // particle properties.

        return particle;
      })
      .filter(particle => !!particle);
  };

  render() {
    const { children } = this.props;
    const { status, particles } = this.state;
    const { generateParticles } = this;

    return children({
      // State
      status,
      particles,

      // Actions
      generateParticles,
    });
  }
}

export default Particles;
